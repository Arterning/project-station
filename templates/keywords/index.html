<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keywords Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0D0D2B',
                        'secondary': '#1E1E3F',
                        'accent': '#3A3A6D',
                        'text-primary': '#E0E0FF',
                        'text-secondary': '#A0A0C0',
                        'cyan-glow': '#00FFFF',
                    }
                }
            }
        }
    </script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0D0D2B; }
        ::-webkit-scrollbar-thumb { background: #3A3A6D; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #00FFFF; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-primary text-text-primary font-mono">
    <div class="container mx-auto max-w-6xl p-8">
        
        <header class="mb-10 flex justify-between items-center">
            <div>
                <a href="{{ url_for('index') }}" class="text-cyan-glow hover:text-white transition-colors">&larr; Back to Projects</a>
                <h1 class="text-4xl font-bold text-cyan-glow tracking-widest mt-2">KEYWORDS</h1>
            </div>
            <button id="open-keyword-modal" class="bg-cyan-glow text-primary font-bold py-2 px-6 rounded-md hover:bg-white hover:shadow-lg hover:shadow-cyan-glow/50 transition-all duration-300">
                + New Keyword
            </button>
        </header>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="mb-4">
                {% for category, message in messages %}
                    <div class="px-4 py-2 rounded-md text-center 
                        {% if category == 'success' %} bg-green-900 border border-green-500 text-green-200 
                        {% else %} bg-red-900 border border-red-500 text-red-200 {% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <main class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% if broad_keywords %}
                {% for keyword in broad_keywords %}
                <div data-href="{{ url_for('keyword_detail', keyword_id=keyword.id) }}" class="clickable-card bg-secondary p-6 rounded-lg border border-accent hover:border-cyan-glow transition-all duration-300 h-full flex flex-col cursor-pointer">
                    <div class="flex items-center gap-2 mb-4">
                        <h2 class="text-2xl font-bold text-text-primary">{{ keyword.keyword_text }}</h2>
                        <a href="https://trends.google.com/trends/explore?q={{ keyword.keyword_text }}" target="_blank" onclick="event.stopPropagation()" class="text-cyan-glow hover:text-white transition-colors">↗</a>
                    </div>
                    
                    {% if keyword.children %}
                    <div class="flex-grow">
                        <h3 class="text-sm text-cyan-glow/80 mb-2">Long-tail Keywords:</h3>
                        <ul class="space-y-2">
                            {% for child in keyword.children %}
                            <li class="flex items-center gap-2 text-text-secondary text-sm">
                                <span>- {{ child.keyword_text }}</span>
                                <a href="https://trends.google.com/trends/explore?q={{ child.keyword_text }}" target="_blank" onclick="event.stopPropagation()" class="text-cyan-glow/70 hover:text-white transition-colors">↗</a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% else %}
                    <div class="flex-grow">
                        <p class="text-text-secondary text-sm">No long-tail keywords.</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="col-span-full text-center py-16 bg-secondary rounded-lg border border-dashed border-accent">
                    <h2 class="text-2xl text-text-secondary">No keywords found.</h2>
                    <button id="open-keyword-modal-alt" class="mt-6 inline-block bg-cyan-glow text-primary font-bold py-2 px-6 rounded-md hover:bg-white transition-all duration-300">
                        Add Your First Keyword
                    </button>
                </div>
            {% endif %}
        </main>
    </div>

    <!-- Modal for Adding Keyword -->
    <div id="keyword-modal" class="modal fixed inset-0 bg-primary bg-opacity-80 flex items-center justify-center p-4 hidden opacity-0 z-50">
        <div class="modal-container bg-secondary border border-accent rounded-lg shadow-xl w-full max-w-2xl transform scale-95">
            <form action="{{ url_for('add_keyword') }}" method="POST" class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl text-cyan-glow">Add New Keyword</h3>
                    <button type="button" class="close-modal text-text-secondary hover:text-white text-2xl">&times;</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-2">Related Project *</label>
                        <select name="project_id" required class="form-input w-full bg-primary border-accent rounded py-2 px-3">
                            <option value="">-- Select a Project --</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.project_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-2">Broad Keyword *</label>
                        <input type="text" name="keyword_text" required placeholder="e.g., AI Avatar" class="form-input w-full bg-primary border-accent rounded py-2 px-3">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-2">Long-tail Keywords (one per line)</label>
                        <textarea name="long_tail_keywords" rows="4" placeholder="e.g., AI avatar generator&#10;AI profile picture" class="form-input w-full bg-primary border-accent rounded py-2 px-3"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-2">Competition Level</label>
                        <select name="competition_level" class="form-input w-full bg-primary border-accent rounded py-2 px-3">
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-secondary mb-2">Competitor Analysis</label>
                        <textarea name="competitor_analysis" rows="3" class="form-input w-full bg-primary border-accent rounded py-2 px-3"></textarea>
                    </div>
                </div>
                <div class="text-right mt-8">
                    <button type="submit" class="bg-cyan-glow text-primary font-bold py-2 px-6 rounded-md hover:bg-white">Save Keyword</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- Clickable Card Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const cards = document.querySelectorAll('.clickable-card');
            cards.forEach(card => {
                card.addEventListener('click', (e) => {
                    // Navigate only if the click is not on a link
                    if (e.target.tagName.toLowerCase() !== 'a') {
                        window.location.href = card.dataset.href;
                    }
                });
            });
        });

        // --- Generic Modal Logic ---
        function setupModal(modalId, openBtnIds) {
            const modal = document.getElementById(modalId);
            if (!modal) return;
            const closeBtns = modal.querySelectorAll('.close-modal');
            
            const toggle = (show) => {
                if (show) {
                    modal.classList.remove('hidden');
                    setTimeout(() => modal.classList.remove('opacity-0'), 10);
                } else {
                    modal.classList.add('opacity-0');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            };

            openBtnIds.forEach(btnId => {
                const openBtn = document.getElementById(btnId);
                if(openBtn) openBtn.addEventListener('click', () => toggle(true));
            });
            
            closeBtns.forEach(btn => btn.addEventListener('click', () => toggle(false)));
            modal.addEventListener('click', e => {
                if (e.target === modal) toggle(false);
            });
        }

        setupModal('keyword-modal', ['open-keyword-modal', 'open-keyword-modal-alt']);
    </script>
</body>
</html>
